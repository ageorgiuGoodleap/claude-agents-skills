#!/usr/bin/env python3
"""
Scan npm dependencies for known vulnerabilities using npm audit.
"""
import subprocess
import sys
import json
import os

def scan_npm_dependencies(package_json_path):
    """Scan npm dependencies for CVEs"""
    package_dir = os.path.dirname(package_json_path) or '.'
    
    try:
        # Run npm audit with JSON output
        result = subprocess.run(
            ['npm', 'audit', '--json'],
            cwd=package_dir,
            capture_output=True,
            text=True
        )
        
        # Parse JSON output
        audit_data = json.loads(result.stdout)
        
        # Print formatted results
        print(f"\n{'='*80}")
        print(f"npm Dependency Vulnerability Scan")
        print(f"Package.json: {package_json_path}")
        print(f"{'='*80}\n")
        
        vulnerabilities = audit_data.get('vulnerabilities', {})
        
        if not vulnerabilities:
            print("‚úÖ No vulnerabilities found!")
            return
        
        # Group by severity
        by_severity = {'critical': [], 'high': [], 'moderate': [], 'low': []}
        
        for pkg_name, vuln_data in vulnerabilities.items():
            severity = vuln_data.get('severity', 'unknown')
            if severity in by_severity:
                by_severity[severity].append((pkg_name, vuln_data))
        
        # Print vulnerabilities by severity
        for severity in ['critical', 'high', 'moderate', 'low']:
            vulns = by_severity[severity]
            if vulns:
                print(f"\n{severity.upper()} Severity ({len(vulns)}):")
                print("-" * 80)
                
                for pkg_name, vuln_data in vulns:
                    via = vuln_data.get('via', [])
                    
                    print(f"\nüì¶ {pkg_name}")
                    print(f"  Current version: {vuln_data.get('range', 'unknown')}")
                    
                    for item in via:
                        if isinstance(item, dict):
                            title = item.get('title', 'Unknown vulnerability')
                            cve = item.get('cve', ['N/A'])
                            url = item.get('url', '')
                            
                            print(f"  ‚ö†Ô∏è  {title}")
                            if cve and cve != ['N/A']:
                                print(f"     CVE: {', '.join(cve)}")
                            if url:
                                print(f"     Info: {url}")
                    
                    # Fix available
                    fix_available = vuln_data.get('fixAvailable', False)
                    if fix_available:
                        if isinstance(fix_available, dict):
                            fix_version = fix_available.get('version', 'latest')
                            print(f"  ‚úÖ Fix: Update to version {fix_version}")
                        else:
                            print(f"  ‚úÖ Fix available: npm update {pkg_name}")
                    else:
                        print(f"  ‚ùå No fix available yet")
        
        # Summary
        metadata = audit_data.get('metadata', {})
        print(f"\n{'='*80}")
        print(f"Summary:")
        print(f"  Total vulnerabilities: {metadata.get('vulnerabilities', {}).get('total', 0)}")
        print(f"  Critical: {metadata.get('vulnerabilities', {}).get('critical', 0)}")
        print(f"  High: {metadata.get('vulnerabilities', {}).get('high', 0)}")
        print(f"  Moderate: {metadata.get('vulnerabilities', {}).get('moderate', 0)}")
        print(f"  Low: {metadata.get('vulnerabilities', {}).get('low', 0)}")
        print(f"{'='*80}\n")
        
    except FileNotFoundError:
        print("Error: npm not found. Ensure Node.js and npm are installed.", file=sys.stderr)
    except json.JSONDecodeError:
        print("Error: Failed to parse npm audit output", file=sys.stderr)
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Usage: python scan_npm_dependencies.py <path-to-package.json>")
        sys.exit(1)
    
    package_json = sys.argv[1]
    
    if not os.path.exists(package_json):
        print(f"Error: {package_json} not found", file=sys.stderr)
        sys.exit(1)
    
    scan_npm_dependencies(package_json)
