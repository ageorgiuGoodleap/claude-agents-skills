#!/usr/bin/env python3
"""
Run Bandit Python security linter on specified directory.
Bandit identifies common security issues in Python code.
"""
import subprocess
import sys
import json

def run_bandit(target_path):
    """Run Bandit scan on target path"""
    try:
        # Run bandit with JSON output for easier parsing
        result = subprocess.run(
            ['bandit', '-r', target_path, '-f', 'json'],
            capture_output=True,
            text=True
        )
        
        if result.returncode != 0 and result.stderr:
            print(f"Error running Bandit: {result.stderr}", file=sys.stderr)
            return None
        
        # Parse JSON output
        findings = json.loads(result.stdout)
        
        # Print formatted results
        print(f"\n{'='*80}")
        print(f"Bandit Security Scan Results for: {target_path}")
        print(f"{'='*80}\n")
        
        for result in findings.get('results', []):
            severity = result['issue_severity']
            confidence = result['issue_confidence']
            issue = result['issue_text']
            filename = result['filename']
            line = result['line_number']
            code = result['code']
            cwe = result.get('issue_cwe', {}).get('id', 'N/A')
            
            print(f"[{severity}] {issue}")
            print(f"  CWE: {cwe}")
            print(f"  File: {filename}:{line}")
            print(f"  Confidence: {confidence}")
            print(f"  Code: {code.strip()}")
            print()
        
        # Summary
        metrics = findings.get('metrics', {})
        total = sum(metrics.values()) if metrics else 0
        print(f"\nTotal Issues Found: {total}")
        print(f"  High: {metrics.get('SEVERITY.HIGH', 0)}")
        print(f"  Medium: {metrics.get('SEVERITY.MEDIUM', 0)}")
        print(f"  Low: {metrics.get('SEVERITY.LOW', 0)}")
        
        return findings
        
    except FileNotFoundError:
        print("Error: Bandit not installed. Install with: pip install bandit", file=sys.stderr)
        return None
    except json.JSONDecodeError:
        print("Error: Failed to parse Bandit output", file=sys.stderr)
        return None

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Usage: python run_bandit.py <path-to-python-code>")
        sys.exit(1)
    
    target = sys.argv[1]
    run_bandit(target)
