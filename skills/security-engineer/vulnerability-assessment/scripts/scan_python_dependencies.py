#!/usr/bin/env python3
"""
Scan Python dependencies for known vulnerabilities using pip-audit.
"""
import subprocess
import sys
import json

def scan_python_dependencies(requirements_file):
    """Scan Python dependencies for CVEs"""
    try:
        # Run pip-audit with JSON output
        result = subprocess.run(
            ['pip-audit', '-r', requirements_file, '--format', 'json'],
            capture_output=True,
            text=True
        )
        
        # Parse JSON output
        vulnerabilities = json.loads(result.stdout)
        
        # Print formatted results
        print(f"\n{'='*80}")
        print(f"Python Dependency Vulnerability Scan")
        print(f"Requirements file: {requirements_file}")
        print(f"{'='*80}\n")
        
        if not vulnerabilities:
            print("‚úÖ No vulnerabilities found!")
            return
        
        # Group by severity
        critical = []
        high = []
        medium = []
        low = []
        
        for vuln in vulnerabilities:
            # Estimate severity based on CVSS if available
            # pip-audit doesn't always provide severity, so we infer from description
            name = vuln.get('name', 'Unknown')
            version = vuln.get('version', 'Unknown')
            vuln_id = vuln.get('id', 'Unknown')
            description = vuln.get('description', '')
            fix_versions = vuln.get('fix_versions', [])
            
            # Simple severity estimation (in reality, check CVSS score)
            if 'critical' in description.lower() or 'remote code execution' in description.lower():
                critical.append(vuln)
            elif 'high' in description.lower() or 'sql injection' in description.lower():
                high.append(vuln)
            elif 'medium' in description.lower():
                medium.append(vuln)
            else:
                low.append(vuln)
        
        # Print by severity
        for severity, vulns in [('CRITICAL', critical), ('HIGH', high), ('MEDIUM', medium), ('LOW', low)]:
            if vulns:
                print(f"\n{severity} Severity ({len(vulns)}):")
                print("-" * 80)
                
                for vuln in vulns:
                    name = vuln.get('name', 'Unknown')
                    version = vuln.get('version', 'Unknown')
                    vuln_id = vuln.get('id', 'Unknown')
                    description = vuln.get('description', 'No description')
                    fix_versions = vuln.get('fix_versions', [])
                    
                    print(f"\nüì¶ {name} {version}")
                    print(f"  Vulnerability: {vuln_id}")
                    print(f"  Description: {description[:200]}...")
                    
                    if fix_versions:
                        print(f"  ‚úÖ Fix: Upgrade to {', '.join(fix_versions)}")
                        print(f"     Command: pip install {name}=={fix_versions[0]}")
                    else:
                        print(f"  ‚ùå No fix available yet")
        
        # Summary
        total = len(vulnerabilities)
        print(f"\n{'='*80}")
        print(f"Summary:")
        print(f"  Total vulnerabilities: {total}")
        print(f"  Critical: {len(critical)}")
        print(f"  High: {len(high)}")
        print(f"  Medium: {len(medium)}")
        print(f"  Low: {len(low)}")
        print(f"{'='*80}\n")
        
    except FileNotFoundError:
        print("Error: pip-audit not installed. Install with: pip install pip-audit", file=sys.stderr)
    except json.JSONDecodeError:
        print("Error: Failed to parse pip-audit output", file=sys.stderr)
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Usage: python scan_python_dependencies.py <path-to-requirements.txt>")
        sys.exit(1)
    
    requirements = sys.argv[1]
    scan_python_dependencies(requirements)
