# Security Implementation Guide

Detailed security patterns and implementation details for technical specifications.

## Password Security

### Storage

**Algorithm:** bcrypt
- Cost factor: 12 (adjustable for future hardware)
- Salt: Automatically generated by bcrypt (unique per password)
- Never store plaintext passwords

**Password Requirements:**
- Minimum 8 characters
- At least 1 uppercase letter
- At least 1 lowercase letter
- At least 1 number
- At least 1 special character (!@#$%^&*)

### Password Validation

**Client-side:** Show requirements in real-time
**Server-side:** Validate all requirements
**Breach detection:** Check against haveibeenpwned API (k-anonymity model)
**Common passwords:** Reject top 10,000 common passwords

### Brute Force Protection

- Rate limit: 5 failed attempts per 15 minutes per IP
- Account lockout: After 10 failed attempts, require email verification to unlock
- CAPTCHA: Show after 3 failed attempts
- Log all failed attempts for security monitoring

---

## Session Management

### Token Generation

- Length: 32 bytes (256 bits)
- Encoding: Base64 URL-safe
- Randomness: Cryptographically secure random (crypto.randomBytes)
- Uniqueness: Check database before issuing

### Token Storage

**Client:** HTTP-only secure cookie
**Server:** Database record with user_id and expiry
**Never in localStorage:** XSS risk
**Never in URL parameters:** Leakage risk

### Session Lifecycle

- Creation: On successful login
- Expiry: 7 days (normal), 30 days ("remember me")
- Renewal: Issue new token when < 24 hours remaining
- Termination: On logout or explicit session deletion

### Session Validation

```python
def validate_session(token):
    session = db.query("SELECT * FROM sessions WHERE token = ? AND expires_at > NOW()", token)
    if not session:
        raise AuthenticationError("Invalid or expired session")
    return session
```

### Logout Behavior

- Single device: Delete current session only
- All devices: Delete all user sessions
- Cascade: Sessions deleted when user account deleted

---

## Email Verification

### Token Generation

- Length: 32 bytes (256 bits)
- Randomness: Cryptographically secure
- One-time use: Mark as consumed after use
- Expiry: 24 hours from generation

### Verification Flow

```
1. User registers → Generate token
2. Store in database (verification_tokens table)
3. Send email with link: https://app.example.com/verify?token=...
4. User clicks link → Validate token
5. Mark email as verified → Mark token as consumed
6. Delete token after 24 hours (cleanup job)
```

### Resend Logic

- Allow resend after 1 minute cooldown
- Invalidate previous token on resend
- Rate limit: 3 resends per hour per email

---

## API Security

### HTTPS Enforcement

- TLS 1.3 (minimum 1.2)
- Redirect HTTP to HTTPS
- HSTS header: `Strict-Transport-Security: max-age=31536000; includeSubDomains`

### CORS Configuration

```javascript
{
  origin: [
    'https://app.example.com',
    'https://www.example.com'
  ],
  credentials: true,  // Allow cookies
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization']
}
```

### Rate Limiting

- IP-based: 1000 requests per hour per IP
- User-based: 5000 requests per hour per authenticated user
- Endpoint-specific overrides (e.g., login: 5 per 15 min)
- Response headers:
  ```
  X-RateLimit-Limit: 1000
  X-RateLimit-Remaining: 999
  X-RateLimit-Reset: 1675863000
  ```

### Input Sanitization

- SQL injection: Use parameterized queries (never string concatenation)
- XSS: Escape all user input in HTML output
- Command injection: Never pass user input to shell commands
- Path traversal: Validate file paths against whitelist

### CSRF Protection

- Use CSRF tokens for all state-changing operations
- Token in cookie + header (double-submit pattern)
- Validate token on server for POST/PUT/PATCH/DELETE

---

## Data Privacy

### GDPR Compliance

- Explicit consent: Checkbox for terms acceptance (unchecked by default)
- Data access: Endpoint to export user data as JSON
- Right to deletion: Endpoint to delete account and all data
- Data portability: Export in machine-readable format (JSON)
- Audit trail: Log all data access and modifications

### PII Encryption

- At rest: AES-256 encryption for sensitive fields (e.g., SSN if stored)
- In transit: TLS 1.3 for all communications
- Key management: AWS KMS or similar (rotate keys annually)

### Logging

- Never log passwords (plaintext or hashed)
- Never log session tokens
- Never log PII in plain text
- Hash email addresses in logs (one-way hash for correlation)
- Structured logging with request ID for traceability

### Data Retention

- Active users: Indefinite (until deletion requested)
- Deleted users: Hard delete after 30-day grace period
- Session logs: 90 days
- Audit logs: 7 years (compliance requirement)

---

## Audit and Monitoring

### Security Events to Log

- All authentication attempts (success and failure)
- Account creation and deletion
- Password changes and resets
- Session creation and destruction
- Permission changes
- Data exports (GDPR requests)

### Log Format

```json
{
  "timestamp": "2025-02-08T10:30:00Z",
  "event": "login_failed",
  "user_id": null,
  "email_hash": "sha256_hash",
  "ip_address": "192.168.1.1",
  "user_agent": "Mozilla/5.0...",
  "reason": "invalid_password",
  "request_id": "req_abc123"
}
```

### Alerts

- Brute force detected: >10 failed logins from single IP in 5 min
- Account takeover suspected: Login from new country without MFA
- Data breach: Unusual volume of data exports
- Rate limit bypass: Requests from distributed IPs exceeding limits

---

## Security Checklist

- [ ] Passwords hashed with bcrypt (cost factor 12)
- [ ] Session tokens cryptographically random (32 bytes)
- [ ] HTTPS enforced with HSTS header
- [ ] Rate limiting on all authentication endpoints
- [ ] SQL injection prevention (parameterized queries)
- [ ] XSS prevention (input escaping)
- [ ] CSRF protection (tokens for state changes)
- [ ] CORS properly configured
- [ ] Audit logging for security events
- [ ] GDPR compliance (consent, export, deletion)
- [ ] PII encrypted at rest and in transit
- [ ] Secrets in environment variables (not code)
- [ ] Email verification for account creation
- [ ] Account lockout after failed attempts
- [ ] Security monitoring and alerts configured
